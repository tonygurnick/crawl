<!doctype>
<html>
<head>
<style>
html {
	font-size: 62.5%;
	height 100%;
}
.recording #preview1 {
	visibility:hidden;
}
.recording #preview2 {
	visibility:visible;
}
#preview1 {
	position: fixed;
	top: 0;
	left: 0;
	width: 100%;
	height: auto%;
	visibility: visible;
}
#preview2 {
	position: fixed;
	top: 1rem;
	left: 1rem;
	border: 1px solid #000;
	width: 160px;
	height: 120px;
	visibility: hidden;
}

#controls {
	position:fixed;
	bottom:5vh;
	left:5vw;
	right:5vw;
	display:flex;
	flex-direction:row;
	align-items:center;
	justify-content:center;
	z-index: 10000;
	background-color: rgba(255,255,255,.5);
	border-rdius: .5rem;
	box-shadow: 0 0 1rem rgba(128,128,128,.5);
}
#controls .button {
        padding:1rem;
        margin: 1rem;
}

</style>
</head>
<body class="droptarget stopped">
		<video id="preview1" autoplay muted></video>
		<video id="preview2" width="160" height="120" autoplay muted></video>
		<div id="controls">
			<button id="startButton" class="button">record</button>
			<button id="stopButton" class="button">stop</button>
			<a id="downloadButton" class="button"> Download</a>
		</div>
</body>
</html>
<script>

const promptly = {
	audio:true,
	video:true,
	videoData: [],
	videoPlayers:[],
	majorView: null,
	minorView:null,
	cameraErrorHandler: function(error) {
		const {name}=error;
		if (name === 'ConstraintNotSatisfiedError') {
 			console.error(`The resolution ${constraints.video.width.exact}px ${constraints.video.height.exact}px is not supported by your device.`);
 		} else if (name === 'PermissionDeniedError') {
 			console.error(`Permissions have not been granted to use your camera and microphone, you need to allow the page access to your devices`);
 		}
		console.error(`getUserMedia error: ${name}`);
	},
	addDomHandlers:function() {
		this.buttonStart.addEventListener("click", this.start.bind(this) );
		this.buttonStop.addEventListener("click", this.stop.bind(this) );
	},
	captureDom:function(){
		this.videoPlayers = document.querySelectorAll('video');
		this.buttonStart = document.getElementById("startButton");
		this.buttonStop = document.getElementById("stopButton");
		this.container = document.body;
		this.buttonDownload = document.getElementById("downloadButton");
	},
	captureStream: function( mediaStream ){
		this.cameraStream = mediaStream;
	},
	requestPermissions: function() {
		return this.camera = navigator.mediaDevices.getUserMedia(this).then(this.captureStream.bind(this));
	},
	attachStreamToDom:function(){
                this.videoPlayers.forEach( vidObj => {
                        vidObj.srcObject = this.cameraStream;
                });
	},
	detachStreamFromDom:function(){
	},
	createRecorder: function(){
		this.recorder = new MediaRecorder(this.cameraStream);
		this.recorder.ondataavailable = event => {
			this.videoData.push(event.data);
		}
		this.recorder.onstop = function(ev){
			let recordedBlob = new Blob(this.videoData, { type: "video/mp4" });

 			this.videoPlayers[0].src = URL.createObjectURL(recordedBlob)
                        this.buttonDownload.href = this.videoPlayers[0].src;
                        this.buttonDownload.download = `magnificent_octopus_${new Date().getTime()}.mp4`;

                        console.log("Successfully recorded " + recordedBlob.size + " bytes of " + recordedBlob.type + " media.");
		}.bind(this)
	},
	start: function(){
		this.container.classList.add("recording");
		this.recorder.start();
	},
	stop: function(){
		this.container.classList.remove("recording");
                this.recorder.stop();
	},
	onWithTheShow: function(){
		this.attachStreamToDom();
		this.createRecorder();
	},
	go:function() {
		this.captureDom();
		this.addDomHandlers();
		this.requestPermissions().then( this.onWithTheShow.bind(this,...arguments) ).catch(this.cameraErrorHandler);
	}
};

promptly.go();
</script>
